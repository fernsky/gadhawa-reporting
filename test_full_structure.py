#!/usr/bin/env python3
"""
Comprehensive test that matches the exact structure of pdf_full_report.html
to verify that TOC page numbering works correctly
"""
import os
import tempfile
from weasyprint import HTML, CSS


def test_full_report_structure():
    """Test TOC page numbering with exact PDF report structure"""
    print("üîç Testing full report structure with TOC page numbering...")

    # Create HTML content that exactly matches pdf_full_report.html structure
    html_content = """
    <!DOCTYPE html>
    <html lang="ne">
    <head>
        <meta charset="UTF-8">
        <title>‡§≤‡•Å‡§ô‡•ç‡§ó‡•ç‡§∞‡•Ä ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ - ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡•ç‡§∞‡§§‡§ø‡§µ‡•á‡§¶‡§®</title>
        
        <style>
            /* Custom Nepali counter style */
            @counter-style nepali-numerals {
                system: numeric;
                symbols: "‡•¶" "‡•ß" "‡•®" "‡•©" "‡•™" "‡•´" "‡•¨" "‡•≠" "‡•Æ" "‡•Ø";
                suffix: "";
            }

            /* Simplified page setup with consistent Nepali numerals */
            @page {
                size: A4;
                margin: 2cm 1.5cm 3cm 1.5cm;
                
                @bottom-right {
                    content: counter(page, nepali-numerals) " | ‡§≤‡•Å‡§ô‡•ç‡§ó‡•ç‡§∞‡•Ä ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ‡§ï‡•ã ‡§™‡§æ‡§∞‡•ç‡§∂‡•ç‡§µ‡§ö‡§ø‡§§‡•ç‡§∞";
                    font-size: 9pt;
                    color: #666;
                    font-family: 'Noto Sans Devanagari', 'DejaVu Sans', sans-serif;
                }
            }

            /* Cover page - no page numbers */
            @page :first {
                @top-left { content: ""; }
                @top-right { content: ""; }
                @bottom-center { content: ""; }
                @bottom-right { content: ""; }
            }

            body {
                font-family: 'Noto Sans Devanagari', 'DejaVu Sans', sans-serif;
                font-size: 11pt;
                line-height: 1.5;
                color: #333;
                margin: 0;
                padding: 0;
            }

            .cover-page {
                page-break-after: always;
                text-align: center;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 70vh;
            }

            .toc-page, .list-page {
                page-break-before: always;
                page-break-after: always;
            }

            .main-content-start {
                page-break-before: always;
            }

            .toc-title {
                font-size: 18pt;
                font-weight: 700;
                color: #1e3a8a;
                border-bottom: 3px solid #0ea5e9;
                padding-bottom: 0.5em;
                margin-bottom: 1.5em;
                text-align: center;
            }

            .toc-item {
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                margin-bottom: 0.4em;
                padding: 0.2em 0;
                border-bottom: 1px dotted #d1d5db;
                page-break-inside: avoid;
            }

            .toc-item .toc-link {
                color: #333;
                text-decoration: none;
                flex-grow: 1;
                margin-right: 1em;
            }

            .toc-item.level-1 {
                font-weight: 600;
                font-size: 12pt;
                margin-top: 1em;
                margin-bottom: 0.5em;
                color: #1e40af;
            }

            .toc-item.level-2 {
                margin-left: 1.5em;
                font-size: 11pt;
                color: #2563eb;
            }

            .page-ref {
                color: #666;
                font-weight: bold;
                min-width: 2em;
                text-align: right;
                margin-left: 1em;
                display: inline-block;
            }

            /* For page references using anchor links */
            .page-ref a::after {
                content: target-counter(attr(href), page, nepali-numerals);
                color: #666;
                font-weight: bold;
            }
            
            /* Hide the actual link text */
            .page-ref a {
                color: #666;
                text-decoration: none;
            }

            .section-break {
                page-break-before: auto;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            .section-break:first-of-type {
                page-break-before: always;
            }

            .category-title {
                font-size: 18pt;
                font-weight: 700;
                text-align: center;
                color: #dc2626;
                margin: 2em 0 1em 0;
                padding: 0.5em;
                page-break-after: avoid;
            }

            .section-content {
                page-break-inside: avoid;
                orphans: 3;
                widows: 3;
                margin-top: 1.5em;
            }

            .section-header.level-2 {
                font-size: 16pt;
                color: #1e40af;
                border-bottom: 2px solid #0ea5e9;
                padding-bottom: 0.3em;
                margin-top: 2em;
                margin-bottom: 1em;
            }

            .content-section {
                margin-bottom: 1em;
                text-align: justify;
                min-height: 20vh;
            }
        </style>
    </head>
    <body>
        <!-- Cover Page -->
        <div class="cover-page">
            <div style="text-align: center; margin-bottom: 4cm;">            
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2cm;">
                    <div style="width: 80px; height: 80px;">
                        <!-- Nepal Government Logo placeholder -->
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="color: #1e3a8a; font-size: 20pt; font-weight: 700; margin-bottom: 0.5em;">
                            ‡§≤‡•Å‡§ô‡•ç‡§ó‡•ç‡§∞‡•Ä ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ
                        </div>
                        <div style="color: #1e40af; font-size: 16pt; font-weight: 600; margin-bottom: 0.5em;">
                            ‡§ó‡§æ‡§â‡§Å‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡§æ‡§≤‡§ø‡§ï‡§æ‡§ï‡•ã ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø
                        </div>
                        <div style="color: #1e40af; font-size: 12pt; margin-bottom: 0.5em;">
                            ‡§≤‡•Å‡§Æ‡•ç‡§¨‡§ø‡§®‡•Ä ‡§™‡•ç‡§∞‡§¶‡•á‡§∂, ‡§®‡•á‡§™‡§æ‡§≤ ‡§∏‡§∞‡§ï‡§æ‡§∞
                        </div>
                    </div>
                    <div style="width: 80px; height: 80px;">
                        <!-- Municipality Logo placeholder -->
                    </div>
                </div>
                
                <!-- Main Title Section -->
                <div style="color: #dc2626; padding: 1.5em; margin: 2cm 0; font-size: 24pt; font-weight: 700;">
                    ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ ‡§™‡§æ‡§∞‡•ç‡§∂‡•ç‡§µ‡§ö‡§ø‡§§‡•ç‡§∞
                </div>

                <!-- Bottom Section -->
                <div style="color: #0f172a; padding: 1em; margin-top: 1cm;">
                    <div style="font-size: 16pt; font-weight: 600;">‡§Æ‡§∏‡•ç‡§Ø‡•å‡§¶‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§µ‡•á‡§¶‡§®</div>
                    <div style="font-size: 18pt; font-weight: 700;">‡•®‡•¶‡•Æ‡•ß</div>
                </div>
            </div>
        </div>

        <!-- Table of Contents -->
        <div class="toc-page">
            <h1 class="toc-title" style="color: #1e3a8a; border-bottom: 3px solid #0ea5e9;">‡§µ‡§ø‡§∑‡§Ø‡§∏‡•Ç‡§ö‡•Ä</h1>
            
            <!-- Categories and Sections -->
            <div class="toc-item level-1">
                <span class="toc-link">‡•ß. ‡§ú‡§®‡§∏‡§æ‡§Ç‡§ñ‡•ç‡§Ø‡§ø‡§ï‡•Ä‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£</span>
                <span class="page-ref"><a href="#category-1"></a></span>
            </div>

            <div class="toc-item level-2">
                <span class="toc-link">‡•ß.‡•ß ‡§ï‡•Å‡§≤ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</span>
                <span class="page-ref"><a href="#section-1-1"></a></span>
            </div>

            <div class="toc-item level-2">
                <span class="toc-link">‡•ß.‡•® ‡§≤‡§ø‡§Ç‡§ó ‡§Ö‡§®‡•Å‡§™‡§æ‡§§</span>
                <span class="page-ref"><a href="#section-1-2"></a></span>
            </div>
            
            <div class="toc-item level-1">
                <span class="toc-link">‡•®. ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ</span>
                <span class="page-ref"><a href="#category-2"></a></span>
            </div>

            <div class="toc-item level-2">
                <span class="toc-link">‡•®.‡•ß ‡§ï‡•É‡§∑‡§ø ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</span>
                <span class="page-ref"><a href="#section-2-1"></a></span>
            </div>

            <div class="toc-item level-2">
                <span class="toc-link">‡•®.‡•® ‡§™‡§∂‡•Å‡§™‡§æ‡§≤‡§®</span>
                <span class="page-ref"><a href="#section-2-2"></a></span>
            </div>
            
            <div class="toc-item level-1">
                <span class="toc-link">‡•©. ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§µ‡§ø‡§ï‡§æ‡§∏</span>
                <span class="page-ref"><a href="#category-3"></a></span>
            </div>

            <div class="toc-item level-2">
                <span class="toc-link">‡•©.‡•ß ‡§Ø‡§æ‡§§‡§æ‡§Ø‡§æ‡§§ ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ</span>
                <span class="page-ref"><a href="#section-3-1"></a></span>
            </div>
        </div>

        <!-- Main Content Start -->
        <div class="main-content-start">
            <div class="section-break" id="category-1">
                <h1 class="category-title" style="color: #dc2626; text-align: center; padding: 0.5em;">
                    ‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶ ‚Äì ‡•ß‡§É ‡§ú‡§®‡§∏‡§æ‡§Ç‡§ñ‡•ç‡§Ø‡§ø‡§ï‡•Ä‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£
                </h1>
                
                <div class="section-content" id="section-1-1">
                    <h2 class="section-header level-2" style="color: #1e40af; border-bottom: 2px solid #0ea5e9; padding-bottom: 0.3em; font-size: 16pt; margin-top: 2em;">
                        ‡•ß.‡•ß ‡§ï‡•Å‡§≤ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ
                    </h2>
                    
                    <div class="content-section" style="margin-left: 0;">
                        <p>‡§≤‡•Å‡§ô‡•ç‡§ó‡•ç‡§∞‡•Ä ‡§ó‡§æ‡§â‡§Å‡§™‡§æ‡§≤‡§ø‡§ï‡§æ‡§ï‡•ã ‡§ï‡•Å‡§≤ ‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡•®‡•¶‡•≠‡•Æ ‡§ï‡•ã ‡§ú‡§®‡§ó‡§£‡§®‡§æ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡•©‡•®,‡•™‡•´‡•¨ ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§</p>
                        <p>‡§Ø‡•ã ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§Æ‡§æ ‡§™‡•Å‡§∞‡•Å‡§∑ ‡•ß‡•¨,‡•®‡•©‡•™ ‡§∞ ‡§Æ‡§π‡§ø‡§≤‡§æ ‡•ß‡•¨,‡•®‡•®‡•® ‡§∞‡§π‡•á‡§ï‡§æ ‡§õ‡§®‡•ç‡•§</p>
                    </div>
                </div>

                <div class="section-content" id="section-1-2">
                    <h2 class="section-header level-2" style="color: #1e40af; border-bottom: 2px solid #0ea5e9; padding-bottom: 0.3em; font-size: 16pt; margin-top: 2em;">
                        ‡•ß.‡•® ‡§≤‡§ø‡§Ç‡§ó ‡§Ö‡§®‡•Å‡§™‡§æ‡§§
                    </h2>
                    
                    <div class="content-section" style="margin-left: 0;">
                        <p>‡§™‡•ç‡§∞‡§§‡§ø ‡•ß‡•¶‡•¶ ‡§Æ‡§π‡§ø‡§≤‡§æ‡§Æ‡§æ ‡•ß‡•¶‡•¶.‡•¶‡•≠ ‡§™‡•Å‡§∞‡•Å‡§∑ ‡§∞‡§π‡•á‡§ï‡•ã ‡§¶‡•á‡§ñ‡§ø‡§®‡•ç‡§õ‡•§</p>
                        <p>‡§Ø‡•ã ‡§Ö‡§®‡•Å‡§™‡§æ‡§§ ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ø ‡§î‡§∏‡§§ ‡§≠‡§®‡•ç‡§¶‡§æ ‡§∞‡§æ‡§Æ‡•ç‡§∞‡•ã ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§</p>
                    </div>
                </div>
            </div>
            
            <div class="section-break" id="category-2">
                <h1 class="category-title" style="color: #dc2626; text-align: center; padding: 0.5em;">
                    ‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶ ‚Äì ‡•®‡§É ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ
                </h1>
                
                <div class="section-content" id="section-2-1">
                    <h2 class="section-header level-2" style="color: #1e40af; border-bottom: 2px solid #0ea5e9; padding-bottom: 0.3em; font-size: 16pt; margin-top: 2em;">
                        ‡•®.‡•ß ‡§ï‡•É‡§∑‡§ø ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®
                    </h2>
                    
                    <div class="content-section" style="margin-left: 0;">
                        <p>‡§Æ‡•Å‡§ñ‡•ç‡§Ø‡§§‡§É ‡§ß‡§æ‡§®, ‡§ó‡§π‡•Å‡§Å, ‡§Æ‡§ï‡•à, ‡§∞ ‡§§‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ó‡§∞‡§ø‡§®‡•ç‡§õ‡•§</p>
                        <p>‡§ï‡•Å‡§≤ ‡§ï‡•É‡§∑‡§ø ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§≠‡•Ç‡§Æ‡§ø ‡•®,‡•©‡•™‡•´ ‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§</p>
                    </div>
                </div>

                <div class="section-content" id="section-2-2">
                    <h2 class="section-header level-2" style="color: #1e40af; border-bottom: 2px solid #0ea5e9; padding-bottom: 0.3em; font-size: 16pt; margin-top: 2em;">
                        ‡•®.‡•® ‡§™‡§∂‡•Å‡§™‡§æ‡§≤‡§®
                    </h2>
                    
                    <div class="content-section" style="margin-left: 0;">
                        <p>‡§ó‡§æ‡§à, ‡§≠‡•à‡§Ç‡§∏‡•Ä, ‡§¨‡§æ‡§ñ‡•ç‡§∞‡§æ, ‡§∞ ‡§ï‡•Å‡§ñ‡•Å‡§∞‡§æ‡§ï‡•ã ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡§ø‡§ï ‡§™‡§æ‡§≤‡§® ‡§ó‡§∞‡§ø‡§®‡•ç‡§õ‡•§</p>
                        <p>‡§¶‡•Å‡§ó‡•ç‡§ß ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§¶‡•à‡§®‡§ø‡§ï ‡•´,‡•¶‡•¶‡•¶ ‡§≤‡§ø‡§ü‡§∞ ‡§™‡•Å‡§ó‡•á‡§ï‡•ã ‡§õ‡•§</p>
                    </div>
                </div>
            </div>
            
            <div class="section-break" id="category-3">
                <h1 class="category-title" style="color: #dc2626; text-align: center; padding: 0.5em;">
                    ‡§™‡§∞‡§ø‡§ö‡•ç‡§õ‡•á‡§¶ ‚Äì ‡•©‡§É ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§µ‡§ø‡§ï‡§æ‡§∏
                </h1>
                
                <div class="section-content" id="section-3-1">
                    <h2 class="section-header level-2" style="color: #1e40af; border-bottom: 2px solid #0ea5e9; padding-bottom: 0.3em; font-size: 16pt; margin-top: 2em;">
                        ‡•©.‡•ß ‡§Ø‡§æ‡§§‡§æ‡§Ø‡§æ‡§§ ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ
                    </h2>
                    
                    <div class="content-section" style="margin-left: 0;">
                        <p>‡§ï‡•Å‡§≤ ‡§∏‡§°‡§ï ‡§≤‡§Æ‡•ç‡§¨‡§æ‡§á ‡•ß‡•®‡•´ ‡§ï‡§ø‡§≤‡•ã‡§Æ‡§ø‡§ü‡§∞ ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§</p>
                        <p>‡§Ø‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ‡•≠‡•´ ‡§ï‡§ø‡§≤‡•ã‡§Æ‡§ø‡§ü‡§∞ ‡§™‡§ï‡•ç‡§ï‡•Ä ‡§∏‡§°‡§ï ‡§∞ ‡•´‡•¶ ‡§ï‡§ø‡§≤‡•ã‡§Æ‡§ø‡§ü‡§∞ ‡§ï‡§ö‡•ç‡§ö‡•Ä ‡§∏‡§°‡§ï ‡§õ‡•§</p>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
    """

    try:
        # Generate PDF
        html_doc = HTML(string=html_content)
        pdf_bytes = html_doc.write_pdf()

        # Save to file
        with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as f:
            f.write(pdf_bytes)
            temp_path = f.name

        print(f"‚úÖ Full report test PDF generated: {temp_path}")
        print(f"üìè PDF size: {len(pdf_bytes)} bytes")

        # Open PDF
        abs_path = os.path.abspath(temp_path)
        if os.name == "nt":  # Windows
            os.startfile(abs_path)

        print("üìñ Please verify TOC page numbers:")
        print("   - Cover page: No page number")
        print("   - TOC page: Should show page ‡•® (2)")
        print("   - Category 1: Should show page ‡•© (3) in TOC")
        print("   - Section 1.1: Should show page ‡•© (3) in TOC")
        print("   - Section 1.2: Should show page ‡•© (3) in TOC")
        print("   - Category 2: Should show page ‡•™ (4) in TOC")
        print("   - Section 2.1: Should show page ‡•™ (4) in TOC")
        print("   - Section 2.2: Should show page ‡•™ (4) in TOC")
        print("   - Category 3: Should show page ‡•´ (5) in TOC")
        print("   - Section 3.1: Should show page ‡•´ (5) in TOC")

        return True

    except Exception as e:
        print(f"‚ùå Error: {e}")
        import traceback

        traceback.print_exc()
        return False


if __name__ == "__main__":
    test_full_report_structure()
